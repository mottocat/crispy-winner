<% path_for_form = comment.persisted? ? comment : [product, comment] %>

<%= form_for(path_for_form) do |f| %>
  <% if comment.errors.any? %>
    <div id="error_explanation">
      <h2><%= pluralize(comment.errors.count, "error") %> prohibited this comment from being saved:</h2>

      <ul>
      <% comment.errors.full_messages.each do |message| %>
        <li><%= message %></li>
      <% end %>
      </ul>
    </div>
  <% end %>

<div class="row py-2" id="<%= dom_id(comment) %>">
  <div class="col-sm-2">
    <%= current_user.try(:full_name) || "YOU" %>
  </div>

  <div class="col-sm-10">
    <% if policy(comment).edit? or policy(comment).new? %>
      <%= f.text_area :body, rows: 4, class: "form-control", placeholder: "Add a comment..." %>
      <ul class="mt-2 text-muted">
        <li>Every user can have only one comment about this product.</li>
        <li>After you added an comment, you can edit the comment.</li>
      </ul>
      <%= f.submit "Save", class: "btn btn-primary" %>
    <% elsif current_user %>
      <div id="<%= dom_id(current_user.comment_on(product)) %>">
        <p>
          <%= current_user.comment_on(product).body %>
          <date>
            <%= link_to current_user.comment_on(product), class: "link blue dib ml1" do %>
              <%= time_ago_in_words current_user.comment_on(product).created_at %> ago
            <% end %>
          </date>
          <%= link_to "[edit]",
              edit_comment_path(product.comments.find_by(author: current_user)),
              class: "link blue" %>
          <%= link_to "&times;".html_safe, 
              product.comments.find_by(author: current_user),
              method: :delete,
              data: { confirm: 'Are you sure?' },
              class: "link blue" %>
        </p>
      </div>

    <% else %>
      <div>
        <p class="text-muted">
          You must sign in for add a comment.
          <%= link_to "[Signin]", 
              new_user_session_path,
              class: "link blue" %>
        </p>
      </div>

    <% end %>
  </div>
<% end %>
